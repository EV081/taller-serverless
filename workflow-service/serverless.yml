service: burger-workflow

frameworkVersion: '4'

provider:
  name: aws
  runtime: python3.10
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  memorySize: 256
  timeout: 20
  environment:
    TABLE_USERS: ${env:TABLE_USUARIOS}
    TABLE_EMPLOYEES: ${env:TABLE_EMPLEADOS}
    TABLE_LOCALS: ${env:TABLE_LOCALES}
    TABLE_ORDERS: ${env:TABLE_PEDIDOS}
    TABLE_PRODUCTS: ${env:TABLE_PRODUCTOS}
    TABLE_ORDER_HISTORY: ${env:TABLE_HISTORIAL_ESTADOS}
    TABLE_TOKENS: ${env:TABLE_TOKENS_USUARIOS}
  iam:
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/LabRole


custom:
  pythonRequirements:
    fileName: ../requirements.txt

functions:
  # Iniciar Step Function cuando se crea un pedido nuevo
  startExecution:
    handler: handlers/start_execution.handler
    environment:
      STATE_MACHINE_ARN: arn:aws:states:us-east-1:${env:AWS_ACCOUNT_ID}:stateMachine:BurgerFlow-dev
    events:
      - eventBridge:
          pattern:
            source:
              - "burger.pedidos"
            detail-type:
              - "CrearPedido"

  # Cambiar estado del pedido y registrar en historial
  cambiarEstado:
    handler: handlers/cambiar_estado.handler
    events:
      - eventBridge:
          pattern:
            source:
              - "burger.cocina"
              - "burger.delivery"
              - "burger.cliente"
            detail-type:
              - "EnPreparacion"
              - "CocinaCompleta"
              - "Empaquetado"
              - "EnCamino"
              - "Entregado"
              - "ConfirmarPedido"

  # Endpoint HTTP para responder callbacks del Step Function
  responderCallback:
    handler: handlers/responder_callback.handler
    environment:
      STATE_MACHINE_ARN: arn:aws:states:us-east-1:${env:AWS_ACCOUNT_ID}:stateMachine:BurgerFlow-dev
    events:
      - httpApi:
          path: /callback/responder
          method: POST

  # Endpoint HTTP para disparar eventos de testing
  triggerEvent:
    handler: handlers/trigger_event.handler
    events:
      - httpApi:
          path: /eventos/trigger
          method: POST

# NOTA: Este servicio NO crea tablas DynamoDB.
# Las tablas son creadas por data-setup/DataPoblator.py
# Este servicio solo mantiene las referencias a las tablas en environment variables
#
# El Step Function (BurgerFlow-dev) se crea MANUALMENTE en AWS Console
# usando el archivo step-function.json
